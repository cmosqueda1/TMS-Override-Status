<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TMS Status + Override Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background: #0a0c10;
        color: #e6edf6;
        font-family: Inter, system-ui, sans-serif;
        margin: 0;
        padding: 20px;
    }

    h1 {
        margin-top: 0;
        font-size: 26px;
        font-weight: 600;
    }

    .card {
        background: #0f1420;
        border: 1px solid #1f2a3a;
        padding: 20px;
        border-radius: 10px;
        max-width: 900px;
        margin-top: 20px;
    }

    textarea, select, button {
        width: 100%;
        font-size: 16px;
        padding: 10px;
        margin-top: 8px;
        border-radius: 6px;
        border: 1px solid #1f2a3a;
        background: #151c28;
        color: #e6edf6;
    }

    button {
        background: #7c3aed;
        cursor: pointer;
        font-weight: 600;
    }

    button:hover {
        opacity: .85;
    }

    .results {
        margin-top: 15px;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        white-space: pre-wrap;
    }

    .stage-ok { color: #10b981; }
    .stage-fail { color: #ef4444; }
    .stage-neutral { color: #fbbf24; }

    .hidden { display: none; }

    .spinner {
        margin-top: 10px;
        display: none;
        color: #22d3ee;
        font-style: italic;
    }

</style>
</head>
<body>

<h1>TMS Status & Override</h1>

<div class="card">
    <label>Enter PRO Numbers (one per line):</label>
    <textarea id="proInput" rows="6" placeholder="61813334&#10;61813333"></textarea>

    <button id="runTraceBtn">Run Trace</button>

    <div id="spinnerTrace" class="spinner">Running trace...</div>

    <div id="traceResults" class="results"></div>
</div>

<!-- Override Section -->
<div class="card hidden" id="overrideCard">

    <h2>Override Stage</h2>

    <label>Select Stage Override:</label>
    <select id="overrideStage">
        <!-- These are EXAMPLES — replace with actual stage list -->
        <option value="4|Out-For-Delivery">Out-For-Delivery (4)</option>
        <option value="3|Delivered">Delivered (3)</option>
        <option value="2|Processing">Processing (2)</option>
        <option value="1|Arrived">Arrived (1)</option>
    </select>

    <button id="runOverrideBtn">Run Override</button>

    <div id="spinnerOverride" class="spinner">Running override + verification...</div>

    <div id="overrideResults" class="results"></div>
</div>


<script>
/********************************************************************
 * Helpers
 ********************************************************************/
function parsePROs() {
    const raw = document.getElementById("proInput").value.trim();
    if (!raw) return [];
    return raw.split(/\n+/).map(v => v.trim()).filter(Boolean);
}

function printTraceResults(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}\n`;
        out += ` Status: ${r.status}\n`;
        out += ` Substatus: ${r.substatus}\n`;
        out += ` Order ID: ${r.order_id}\n`;
        out += ` Location: ${r.loc}\n`;
        out += ` PU: ${r.pu}\n`;
        out += `---\n`;
    }
    return out;
}

function printOverrideResults(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}\n`;
        out += ` Before: ${r.status}\n`;
        out += ` Override Applied: ${r.override_ok ? "YES" : "NO"}\n`;
        out += ` Verified Status: ${r.verified_status}\n`;
        out += ` Verified: ${r.verified ? "✓ SUCCESS" : "✗ FAILED"}\n\n`;
    }
    return out;
}

/********************************************************************
 * Step 1 — Run Trace
 ********************************************************************/
document.getElementById("runTraceBtn").onclick = async () => {
    const pros = parsePROs();
    if (!pros.length) {
        alert("Please enter at least one PRO.");
        return;
    }

    // UI prep
    document.getElementById("runTraceBtn").disabled = true;
    document.getElementById("spinnerTrace").style.display = "block";
    document.getElementById("traceResults").textContent = "";
    document.getElementById("overrideCard").classList.add("hidden");

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pros, mode: "trace" })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("traceResults").textContent = "ERROR: " + data.error;
        } else {
            document.getElementById("traceResults").textContent =
                printTraceResults(data.results);

            // Show Override section
            document.getElementById("overrideCard").classList.remove("hidden");
        }

    } catch (err) {
        document.getElementById("traceResults").textContent = "ERROR: " + err;
    }

    // Reset UI
    document.getElementById("spinnerTrace").style.display = "none";
    document.getElementById("runTraceBtn").disabled = false;
};

/********************************************************************
 * Step 2 — Run Override (after trace)
 ********************************************************************/
document.getElementById("runOverrideBtn").onclick = async () => {
    const pros = parsePROs();

    const stageValue = document.getElementById("overrideStage").value;
    const [stage_code, stage_label] = stageValue.split("|");

    document.getElementById("runOverrideBtn").disabled = true;
    document.getElementById("spinnerOverride").style.display = "block";
    document.getElementById("overrideResults").textContent = "";

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pros,
                mode: "override",
                override: {
                    enabled: true,
                    stage_code: Number(stage_code),
                    stage_label: stage_label
                }
            })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("overrideResults").textContent = 
                "ERROR: " + data.error;
        } else {
            document.getElementById("overrideResults").textContent =
                printOverrideResults(data.results);
        }

    } catch (err) {
        document.getElementById("overrideResults").textContent = 
            "ERROR: " + err;
    }

    document.getElementById("spinnerOverride").style.display = "none";
    document.getElementById("runOverrideBtn").disabled = false;
};
</script>

</body>
</html>
