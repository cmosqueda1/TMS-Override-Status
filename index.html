<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TMS Status + Override</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* -------------------------------
   Global Styles
--------------------------------*/
body {
    background: #0a0c10;
    color: #e6edf6;
    font-family: Inter, system-ui, sans-serif;
    margin: 0;
    padding: 20px;
}

h1 {
    margin-top: 0;
    font-size: 26px;
    font-weight: 600;
}

.card {
    background: #0f1420;
    border: 1px solid #1f2a3a;
    padding: 20px;
    border-radius: 10px;
    max-width: 900px;
    margin-top: 20px;
}

textarea, select, button {
    width: 100%;
    font-size: 16px;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    border: 1px solid #1f2a3a;
    background: #151c28;
    color: #e6edf6;
}

button {
    background: #7c3aed;
    cursor: pointer;
    font-weight: 600;
}

button:hover {
    opacity: .85;
}

button:disabled {
    opacity: .45;
    cursor: not-allowed;
}

.results {
    margin-top: 15px;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    white-space: pre-wrap;
    line-height: 1.35;
}

.spinner {
    margin-top: 10px;
    display: none;
    color: #22d3ee;
    font-style: italic;
}

.hidden {
    display: none;
}

.disabled {
    opacity: 0.4;
    pointer-events: none;
}

/* Raw response block */
details.raw-block {
    margin-top: 8px;
    background: #151c28;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #1f2a3a;
}
details.raw-block summary {
    cursor: pointer;
    color: #22d3ee;
    font-weight: 600;
}

.success {
    color: #10b981;
}

.fail {
    color: #ef4444;
}

.neutral {
    color: #fbbf24;
}
</style>
</head>
<body>

<h1>TMS Status & Stage Override</h1>

<!-- ==============================
     TRACE CARD
=================================-->
<div class="card">
    <label>Enter PRO Numbers (one per line):</label>
    <textarea id="proInput" rows="6" placeholder="61813334&#10;61813333"></textarea>

    <button id="runTraceBtn">Run Trace</button>

    <div id="spinnerTrace" class="spinner">Running trace...</div>

    <div id="traceResults" class="results"></div>
</div>


<!-- ==============================
     OVERRIDE CARD
=================================-->
<div class="card hidden" id="overrideCard">

    <h2>Override TMS Stage</h2>

    <label>Select Stage:</label>
    <select id="overrideStage">
        <!-- Replace / extend as needed -->
        <option value="4|Out-For-Delivery">Out-For-Delivery (4)</option>
        <option value="3|Delivered">Delivered (3)</option>
        <option value="2|Processing">Processing (2)</option>
        <option value="1|Arrived">Arrived (1)</option>
    </select>

    <button id="runOverrideBtn" disabled>Run Override</button>

    <div id="spinnerOverride" class="spinner">Running override + verification...</div>

    <div id="overrideResults" class="results"></div>
</div>


<script>
/* ========================================================
   Helper to parse PROs
=========================================================*/
function parsePROs() {
    const raw = document.getElementById("proInput").value.trim();
    if (!raw) return [];
    return raw.split(/\n+/).map(v => v.trim()).filter(Boolean);
}

/* ========================================================
   Formatting helpers
=========================================================*/
function formatTrace(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}
 Status: ${r.status}
 Substatus: ${r.substatus}
 Order ID: ${r.order_id}
 Location: ${r.loc}
 PU: ${r.pu}
---
`;
    }
    return out;
}

function formatOverride(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}
 Before: ${r.status}
 Override Applied: ${r.override_ok ? "YES" : "NO"}
 Verified Status: ${r.verified_status}
 Verified: ${r.verified ? "✓ SUCCESS" : "✗ FAILED"}
`;

        if (r.override_error) {
            out += ` ERROR: ${r.override_error}\n`;
        }

        out += `---\n`;
    }
    return out;
}

/* ========================================================
   1) RUN TRACE
=========================================================*/
document.getElementById("runTraceBtn").onclick = async () => {
    const pros = parsePROs();
    if (!pros.length) {
        alert("Please enter at least one PRO.");
        return;
    }

    document.getElementById("runTraceBtn").disabled = true;
    document.getElementById("spinnerTrace").style.display = "block";
    document.getElementById("traceResults").textContent = "";
    document.getElementById("overrideCard").classList.add("hidden");

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pros,
                mode: "trace"
            })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("traceResults").textContent = "ERROR: " + data.error;
        } else {
            document.getElementById("traceResults").textContent =
                formatTrace(data.results);

            document.getElementById("overrideCard").classList.remove("hidden");
            document.getElementById("runOverrideBtn").disabled = false;
        }

    } catch (err) {
        document.getElementById("traceResults").textContent = "ERROR: " + err;
    }

    document.getElementById("spinnerTrace").style.display = "none";
    document.getElementById("runTraceBtn").disabled = false;
};


/* ========================================================
   2) RUN OVERRIDE (AFTER TRACE)
=========================================================*/
document.getElementById("runOverrideBtn").onclick = async () => {
    const pros = parsePROs();

    const stageVal = document.getElementById("overrideStage").value;
    const [stage_code, stage_label] = stageVal.split("|");

    document.getElementById("runOverrideBtn").disabled = true;
    document.getElementById("spinnerOverride").style.display = "block";
    document.getElementById("overrideResults").textContent = "";

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pros,
                mode: "override",
                override: {
                    enabled: true,
                    stage_code: Number(stage_code),
                    stage_label: stage_label
                }
            })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("overrideResults").textContent =
                "ERROR: " + data.error;
        } else {
            document.getElementById("overrideResults").textContent =
                formatOverride(data.results);
        }

    } catch (err) {
        document.getElementById("overrideResults").textContent =
            "ERROR: " + err;
    }

    document.getElementById("spinnerOverride").style.display = "none";
    document.getElementById("runOverrideBtn").disabled = false;
};
</script>

</body>
</html>
