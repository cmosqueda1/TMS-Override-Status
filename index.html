<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TMS Status & Override</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    background: #0a0c10;
    color: #e6edf6;
    font-family: Inter, system-ui, sans-serif;
    margin: 0;
    padding: 20px;
}

.card {
    background: #0f1420;
    border: 1px solid #1f2a3a;
    padding: 20px;
    border-radius: 10px;
    max-width: 900px;
    margin-top: 20px;
}

textarea, select, button {
    width: 100%;
    font-size: 16px;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    border: 1px solid #1f2a3a;
    background: #151c28;
    color: #e6edf6;
}

button {
    background: #7c3aed;
    cursor: pointer;
    font-weight: 600;
}

button:hover {
    opacity: .85;
}

button:disabled {
    opacity: .45;
    cursor: not-allowed;
}

.spinner {
    margin-top: 10px;
    display: none;
    color: #22d3ee;
    font-style: italic;
}

.results {
    margin-top: 15px;
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    line-height: 1.35;
}

.hidden {
    display: none;
}
</style>
</head>
<body>

<h1>TMS Status & Stage Override</h1>

<!-- ==================================
     TRACE SECTION
=================================== -->
<div class="card">
    <label>Enter PRO Numbers (one per line):</label>
    <textarea id="proInput" rows="6" placeholder="61813334&#10;61813333"></textarea>

    <button id="runTraceBtn">Run Trace</button>

    <div id="spinnerTrace" class="spinner">Running trace...</div>

    <div id="traceResults" class="results"></div>
</div>

<!-- ==================================
     OVERRIDE SECTION
=================================== -->
<div class="card hidden" id="overrideCard">

    <h2>Override TMS Stage</h2>

    <label>Select Stage:</label>
    <select id="overrideStage">
        <option value="-4">overide to Tendered</option>
        <option value="-3">overide to Load Building</option>
        <option value="-2">overide to Quote</option>
        <option value="-1">overide to Cancelled</option>
        <option value="0">overide to Pickup</option>
        <option value="1">overide to Linehaul</option>
        <option value="2">overide to Pickup Complete</option>
        <option value="3">overide to Linehaul Complete</option>
        <option value="4">overide to Out-For-Delivery</option>
    </select>

    <button id="runOverrideBtn" disabled>Run Override</button>

    <div id="spinnerOverride" class="spinner">Running override & verification...</div>

    <div id="overrideResults" class="results"></div>
</div>


<script>
// =======================================
// Utility to parse multi-line PRO input
// =======================================
function parsePROs() {
    const raw = document.getElementById("proInput").value.trim();
    if (!raw) return [];
    return raw.split(/\n+/).map(v => v.trim()).filter(Boolean);
}

// =======================================
// Format trace results
// =======================================
function formatTrace(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}
 Status: ${r.status}
 Substatus: ${r.substatus}
 Order ID: ${r.order_id}
 Location: ${r.loc}
 PU: ${r.pu}
---
`;
    }
    return out;
}

// =======================================
// Format override results
// =======================================
function formatOverride(results) {
    let out = "";
    for (const r of results) {
        out += `PRO: ${r.pro}
 Before: ${r.status}
 Override Applied: ${r.override_ok ? "YES" : "NO"}
 Verified Status: ${r.verified_status}
 Verified: ${r.verified ? "✓ SUCCESS" : "✗ FAILED"}
`;

        if (r.override_error) {
            out += ` ERROR: ${r.override_error}\n`;
        }

        out += `---\n`;
    }
    return out;
}

// =======================================
// RUN TRACE
// =======================================
document.getElementById("runTraceBtn").onclick = async () => {
    const pros = parsePROs();
    if (!pros.length) {
        alert("Please enter at least one PRO.");
        return;
    }

    document.getElementById("runTraceBtn").disabled = true;
    document.getElementById("spinnerTrace").style.display = "block";
    document.getElementById("traceResults").textContent = "";
    document.getElementById("overrideCard").classList.add("hidden");

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pros,
                mode: "trace"
            })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("traceResults").textContent = "ERROR: " + data.error;
        } else {
            document.getElementById("traceResults").textContent = formatTrace(data.results);
            document.getElementById("overrideCard").classList.remove("hidden");
            document.getElementById("runOverrideBtn").disabled = false;
        }

    } catch (err) {
        document.getElementById("traceResults").textContent = "ERROR: " + err;
    }

    document.getElementById("spinnerTrace").style.display = "none";
    document.getElementById("runTraceBtn").disabled = false;
};

// =======================================
// RUN OVERRIDE
// =======================================
document.getElementById("runOverrideBtn").onclick = async () => {
    const pros = parsePROs();
    const stage_code = Number(document.getElementById("overrideStage").value);

    document.getElementById("runOverrideBtn").disabled = true;
    document.getElementById("spinnerOverride").style.display = "block";
    document.getElementById("overrideResults").textContent = "";

    try {
        const res = await fetch("/api/tms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pros,
                mode: "override",
                override: {
                    enabled: true,
                    stage_code
                }
            })
        });

        const data = await res.json();

        if (data.error) {
            document.getElementById("overrideResults").textContent = "ERROR: " + data.error;
        } else {
            document.getElementById("overrideResults").textContent = formatOverride(data.results);
        }

    } catch (err) {
        document.getElementById("overrideResults").textContent = "ERROR: " + err;
    }

    document.getElementById("spinnerOverride").style.display = "none";
    document.getElementById("runOverrideBtn").disabled = false;
};
</script>

</body>
</html>
